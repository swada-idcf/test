# 日次課金チェック

# チェックの流れ
## vm
#### ①　対象のsubscriptionを確認してinvoice_itemで使うsubscription_idを取得する。    
ex. `47eb7f82-9ef8-426a-a06f-cc4b5b57cb49_light.S2_2017-01-11`  
subscription  
```sql
SELECT id, catalog_product_id, status, first_charged_at, terminated_at, created_at FROM selfportal.subscription where cloudstack_resource_uuid = '47eb7f82-9ef8-426a-a06f-cc4b5b57cb49';
```

```
+-------------------+-----------+---------------------+---------------------+-----------+
| id   | catalog_product_id | status | first_charged_at | terminated_at | created_at  |
+-------------------+-----------+---------------------+---------------------+-----------+
|950114	18292	40	2016-12-21 10:27:15	2016-12-26 11:02:42	2016-12-21 10:25:06           |
|958858	18322	40	2016-12-26 11:02:42	2017-01-11 16:50:45	2016-12-26 11:02:44           |
|985177	18291	40	2017-01-11 16:50:45	2017-01-11 17:04:21	2017-01-11 16:50:47           |
|985204	18322	40	2017-01-11 17:04:21	2017-01-12 16:12:47	2017-01-11 17:04:22           |
|987141	18291	20	2017-01-12 16:12:47	2017-01-12 16:12:47                             |
+-------------------+-----------+---------------------+---------------------+-----------+

```
#### ② invoice_itemを取得する。対象となる日付のquantityを確認する。  
```sql
SELECT id, invoice_id, subscription_id, title, quantity, amount, discount_rate, tax_percent, tax, net, service_start_date, service_end_date FROM selfportal.invoice_item where subscription_id IN ('950114', '958858', '985177', '985204', '987141');
```

```
+-------------------+-----------+---------------------+---------------------+-----------+----------------------+-------------+
|id| invoice_id | subscription_id | title | quantity | amount | discount_rate | tax_percent | tax | net | service_start_date | service_end_date |
+-------------------+-----------+---------------------+---------------------+-----------+-----------+------------------------+
|49317084  |  6231326  |  950114  | highcpu.L8 | 120.6264  |  4106 |  10  |  8  | 328 | 4434 |  2016-12-21 | 2016-12-26 |
|49317086  |  6231326  |  958858  | light.S2   | 132.9550  |  346  |  10  |  8  | 27  | 373  |  2016-12-26 | 2016-12-31 |
|50984075  |  6458792  |  958858  | light.S2   | 263.7733  |  688  |  10  |  8  | 55  | 743  |  2017-01-01 | 2017-01-11 |
|50984079  |  6458792  |  985177  | highcpu.M4 | 0.2267    |　　2    |  10  |  8  | 0   | 2    |　 2017-01-11 | 2017-01-11 |
|50984080  |  6458792  |  985204  | light.S2   | 39.9864   | 　103  |  10  |  8  | 8   | 111  |  2017-01-11 | 2017-01-12 |
|50984081  |  6458792  |  987141  | highcpu.M4 | 127.7869  |  2184 |  10  |  8  | 174 | 2358 |  2017-01-12 | 2017-01-17 |
+-------------------+-----------+---------------------+---------------------+-----------+-----------+------------------------+
```

#### ③　usageを確認する(cloud_usage)。usage_displayを確認する。
```sql
(je0-portaldb02) cloud_usage
select zone_id, description, usage_display, start_date, end_date from cloud_usage.cloud_usage where usage_id=183811 and usage_type=1 order by start_date;
```

```
+-------------------+-----------+---------------------+---------------------+-----------+----------------------+-------------+
|zone_id| description       | usage_display                                        | start_date        | end_date            |
+-------------------+-----------+---------------------+---------------------+-----------+-----------+------------------------+
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2016-12-31 15:00:00	2017-01-01 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2017-01-01 15:00:00	2017-01-02 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2017-01-02 15:00:00	2017-01-03 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2017-01-03 15:00:00	2017-01-04 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2017-01-04 15:00:00	2017-01-05 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2017-01-05 15:00:00	2017-01-06 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2017-01-06 15:00:00	2017-01-07 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2017-01-07 15:00:00	2017-01-08 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2017-01-08 15:00:00	2017-01-09 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	24 Hrs	2017-01-09 15:00:00	2017-01-10 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	23.662222 Hrs	2017-01-10 15:00:00	2017-01-11 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 20) (Template: 39157)	0.170556 Hrs	2017-01-10 15:00:00	2017-01-11 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 41) (Template: 39157)	16.182222 Hrs	2017-01-11 15:00:00	2017-01-12 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 20) (Template: 39157)	7.723889 Hrs	2017-01-11 15:00:00	2017-01-12 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 20) (Template: 39157)	24 Hrs	2017-01-12 15:00:00	2017-01-13 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 20) (Template: 39157)	24 Hrs	2017-01-13 15:00:00	2017-01-14 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 20) (Template: 39157)	24 Hrs	2017-01-14 15:00:00	2017-01-15 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 20) (Template: 39157)	24 Hrs	2017-01-15 15:00:00	2017-01-16 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 20) (Template: 39157)	24 Hrs	2017-01-16 15:00:00	2017-01-17 14:59:59
7	DME1-00999-KAWAKAMI running time (ServiceOffering: 20) (Template: 39157)	24 Hrs	2017-01-17 15:00:00	2017-01-18 14:59:59
				
```

#### ④invoice_itemのquantityとusageのusage_displayを比較して数値に大きな差異がないか確認する。  
上記の場合はlight.S2の39.9864とusage_displayの16.182222に差異があるのがわかる。  
